<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MCQ & SAQ Quiz Interface - Sets</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <style>
      #results-panel {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        z-index: 1050;
        background: #fff;
        padding: 15px 25px;
        border: 2px solid #ccc;
        border-radius: 8px 0 0 8px;
        box-shadow: -2px 2px 12px rgba(0, 0, 0, 0.15);
        max-width: 360px;
      }
      .option-wrapper { transition: background .15s, color .15s; }
      .correct-fill { font-weight: 600; margin-top: .5rem; }
      pre.example-json { max-height: 240px; overflow:auto; background:#0b1220; color: #d6e9ff; padding:12px; border-radius:6px;}
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar bg-primary navbar-expand-lg bg-body-tertiary" data-bs-theme="dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">prac-for-exam</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" href="index.html">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="flash_card.html" aria-current="page"
                  >Flash Card</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="mock_test.html">Mock Test</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="checklist.html">Checklist</a>
              </li>
              <!-- <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Dropdown
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">Action</a></li>
            <li><a class="dropdown-item" href="#">Another action</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#">Something else here</a></li>
          </ul>
        </li> -->
            </ul>
          </div>
        </div>
      </nav>

    <div class="container py-5">
      <h1 class="text-center mb-4">Quiz Generator (Sets, MCQ, Multi-select, SAQ & Fill-in)</h1>

      <div class="mb-4">
        <p>Paste JSON here. Either provide a top-level <code>sets</code> array (each set an object like in your example), or a single quiz object with keys <code>mcqs</code>, <code>multi_mcqs</code>, <code>saqs</code>, <code>fill_blanks</code>.</p>

        <pre class="example-json"><code>{
  "sets": [
    {
      "set_number": 1,
      "mcqs": [...],
      "fill_in_the_blanks": [...],
      "saqs": [...],
      "total_marks": 25
    },
    ...
  ]
}</code></pre>

        <label for="jsonInput" class="form-label">Paste Quiz JSON Here:</label>
        <textarea id="jsonInput" class="form-control" rows="12" placeholder='Paste your JSON with "sets" here...'></textarea>
        <div class="mt-2">
          <button class="btn btn-success" id="generate-btn">Generate Quiz (pick one random set)</button>
          <button class="btn btn-outline-secondary" id="regenerate-btn" title="Pick another random set from the loaded JSON">Pick another set</button>
          <button class="btn btn-outline-danger" id="clear-btn">Clear</button>
        </div>
      </div>

      <div id="selected-set-info" class="mb-3"></div>

      <div class="card shadow p-4" id="quiz-container"></div>

      <div class="text-center mt-4">
        <button class="btn btn-primary" id="submit-btn">Submit</button>
      </div>
    </div>

    <div id="results-panel">
      <div class="fw-bold mb-2" id="results"></div>
      <div id="results-breakdown" style="font-size:0.9rem;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js"></script>

    <script>
      // Utility: shuffle array in-place
      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      // Normalize the possible different property names (fill_in_the_blanks vs fill_blanks)
      function normalizeSet(obj) {
        const set = Object.assign({}, obj);
        // accept both names
        if (!set.fill_blanks && set.fill_in_the_blanks) {
          set.fill_blanks = set.fill_in_the_blanks;
        }
        // accept old multi name
        if (!set.multi_mcqs && set.multi_selects) {
          set.multi_mcqs = set.multi_selects;
        }
        return set;
      }

      let loadedJson = null;      // original parsed JSON
      let currentSet = null;      // the set object chosen & normalized
      let currentSetIndex = null; // index in loadedJson.sets if available
      const quizContainer = document.getElementById('quiz-container');
      const selectedSetInfo = document.getElementById('selected-set-info');

      function renderQuizFromSet(setObj) {
        const data = normalizeSet(setObj || {});
        currentSet = data;
        quizContainer.innerHTML = '';
        selectedSetInfo.innerHTML = '';

        // show set header if available
        const header = document.createElement('div');
        header.className = 'mb-3';
        const setNum = (data.set_number !== undefined) ? `Set ${data.set_number}` : (currentSetIndex !== null ? `Set #${currentSetIndex+1}` : 'Selected Set');
        header.innerHTML = `<h4>${setNum}</h4>`;
        selectedSetInfo.appendChild(header);

        // Helper to create a section title
        function sectionTitle(text) {
          const el = document.createElement('h4');
          el.className = 'mt-4';
          el.innerText = text;
          return el;
        }

        // MCQs
        if (Array.isArray(data.mcqs) && data.mcqs.length) {
          const mcqSection = document.createElement('div');
          mcqSection.appendChild(sectionTitle('Multiple Choice Questions'));
          data.mcqs.forEach((q, index) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'mb-3';
            const qTitle = document.createElement('h5');
            qTitle.innerText = `${index + 1}. ${q.question}`;
            qDiv.appendChild(qTitle);
            if (q.image) {
              const img = document.createElement('img');
              img.src = q.image;
              img.className = 'img-fluid rounded mb-2';
              qDiv.appendChild(img);
            }
            const optionsDiv = document.createElement('div');
            const shuffled = shuffle([...q.options || []]);
            shuffled.forEach(opt => {
              const wrapper = document.createElement('div');
              wrapper.className = 'form-check option-wrapper';
              const input = document.createElement('input');
              input.type = 'radio';
              input.name = `mcq_${index}`;
              input.value = opt;
              input.className = 'form-check-input me-2';
              const label = document.createElement('label');
              label.className = 'form-check-label';
              label.appendChild(input);
              label.appendChild(document.createTextNode(opt));
              wrapper.appendChild(label);
              optionsDiv.appendChild(wrapper);
            });
            qDiv.appendChild(optionsDiv);
            mcqSection.appendChild(qDiv);
          });
          quizContainer.appendChild(mcqSection);
        }

        // Multi-select
        if (Array.isArray(data.multi_mcqs) && data.multi_mcqs.length) {
          const multiSection = document.createElement('div');
          multiSection.appendChild(sectionTitle('Multi-Select Questions'));
          data.multi_mcqs.forEach((q, index) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'mb-3';
            const qTitle = document.createElement('h5');
            qTitle.innerText = `${index + 1}. ${q.question} (Select all that apply)`;
            qDiv.appendChild(qTitle);
            if (q.image) {
              const img = document.createElement('img');
              img.src = q.image;
              img.className = 'img-fluid rounded mb-2';
              qDiv.appendChild(img);
            }
            const optionsDiv = document.createElement('div');
            const shuffled = shuffle([...q.options || []]);
            shuffled.forEach(opt => {
              const wrapper = document.createElement('div');
              wrapper.className = 'form-check option-wrapper';
              const input = document.createElement('input');
              input.type = 'checkbox';
              input.name = `multi_${index}`;
              input.value = opt;
              input.className = 'form-check-input me-2';
              const label = document.createElement('label');
              label.className = 'form-check-label';
              label.appendChild(input);
              label.appendChild(document.createTextNode(opt));
              wrapper.appendChild(label);
              optionsDiv.appendChild(wrapper);
            });
            qDiv.appendChild(optionsDiv);
            multiSection.appendChild(qDiv);
          });
          quizContainer.appendChild(multiSection);
        }

        // SAQs
        if (Array.isArray(data.saqs) && data.saqs.length) {
          const saqSection = document.createElement('div');
          saqSection.appendChild(sectionTitle('Short Answer Questions'));
          data.saqs.forEach((q, index) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'mb-3';
            const qTitle = document.createElement('h5');
            qTitle.innerText = `${index + 1}. ${q.question} (${q.marks ?? ''} marks)`;
            qDiv.appendChild(qTitle);
            if (q.image) {
              const img = document.createElement('img');
              img.src = q.image;
              img.className = 'img-fluid rounded mb-2';
              qDiv.appendChild(img);
            }
            const textArea = document.createElement('textarea');
            textArea.className = 'form-control mb-2';
            textArea.rows = 4;
            textArea.name = `saq_${index}`;
            qDiv.appendChild(textArea);

            const answerBtn = document.createElement('button');
            answerBtn.className = 'btn btn-sm btn-outline-info mt-2';
            answerBtn.type = 'button';
            answerBtn.innerText = 'Show Sample Answer';

            const answerDiv = document.createElement('div');
            answerDiv.className = 'alert alert-info mt-2 d-none';
            answerDiv.innerHTML = `<strong>Sample Answer:</strong> ${q.sample_answer ? q.sample_answer : '<em>No sample answer available.</em>'}`;

            answerBtn.addEventListener('click', () => answerDiv.classList.toggle('d-none'));

            qDiv.appendChild(answerBtn);
            qDiv.appendChild(answerDiv);
            saqSection.appendChild(qDiv);
          });
          quizContainer.appendChild(saqSection);
        }

        // Fill in the blanks
        if (Array.isArray(data.fill_blanks) && data.fill_blanks.length) {
          const fillSection = document.createElement('div');
          fillSection.appendChild(sectionTitle('Fill in the Blanks'));
          data.fill_blanks.forEach((q, index) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'mb-3';
            const qTitle = document.createElement('h5');
            qTitle.innerText = `${index + 1}. ${q.question}`;
            qDiv.appendChild(qTitle);
            const input = document.createElement('input');
            input.type = 'text';
            input.name = `fill_${index}`;
            input.className = 'form-control';
            input.placeholder = 'Your answer...';
            qDiv.appendChild(input);

            // place to show correct answer when wrong
            const correctDiv = document.createElement('div');
            correctDiv.className = 'text-muted correct-fill d-none';
            correctDiv.innerHTML = `Correct: <span class="fw-bold"></span>`;
            qDiv.appendChild(correctDiv);

            fillSection.appendChild(qDiv);
          });
          quizContainer.appendChild(fillSection);
        }

        if (!quizContainer.innerHTML.trim()) {
          quizContainer.innerHTML = '<p class="text-muted">No questions found in the chosen set.</p>';
        }
      }

      // Pick random set from loadedJson
      function pickRandomSet() {
        if (!loadedJson) return null;
        if (Array.isArray(loadedJson.sets) && loadedJson.sets.length) {
          const idx = Math.floor(Math.random() * loadedJson.sets.length);
          currentSetIndex = idx;
          return loadedJson.sets[idx];
        }
        // fallback: if user pasted a single quiz (not a sets container)
        return loadedJson;
      }

      // Handle Generate
      document.getElementById('generate-btn').addEventListener('click', () => {
        const val = document.getElementById('jsonInput').value.trim();
        if (!val) { alert('Please paste JSON first.'); return; }
        try {
          const parsed = JSON.parse(val);
          loadedJson = parsed;
          // If a sets array present, pick random set; else treat parsed as single set object
          let toRender = pickRandomSet();
          if (!toRender) {
            // try handle legacy keys directly (mcqs etc.)
            toRender = parsed;
            currentSetIndex = null;
          }
          // normalize some names for backwards compatibility
          if (toRender) {
            renderQuizFromSet(normalizeSet(toRender));
            document.getElementById('results').innerText = '';
            document.getElementById('results-breakdown').innerText = '';
          } else {
            quizContainer.innerHTML = '<p class="text-danger">No usable set found in JSON.</p>';
          }
        } catch (err) {
          alert('Invalid JSON: ' + err.message);
        }
      });

      // Regenerate (pick another random set from already loaded JSON)
      document.getElementById('regenerate-btn').addEventListener('click', () => {
        if (!loadedJson) { alert('Load JSON first (click Generate Quiz).'); return; }
        const toRender = pickRandomSet();
        if (toRender) {
          renderQuizFromSet(normalizeSet(toRender));
          document.getElementById('results').innerText = '';
          document.getElementById('results-breakdown').innerText = '';
        } else {
          alert('No sets found to pick from.');
        }
      });

      // Clear
      document.getElementById('clear-btn').addEventListener('click', () => {
        document.getElementById('jsonInput').value = '';
        quizContainer.innerHTML = '';
        selectedSetInfo.innerHTML = '';
        document.getElementById('results').innerText = '';
        document.getElementById('results-breakdown').innerText = '';
        loadedJson = null; currentSet = null; currentSetIndex = null;
      });

      // Submit handler: score MCQs and multi and fill_blanks only (SAQs are left for manual grading)
      document.getElementById('submit-btn').addEventListener('click', () => {
        if (!currentSet) { alert('No quiz loaded.'); return; }
        let score = 0;
        let totalCount = 0;
        const breakdown = [];

        // MCQs
        if (Array.isArray(currentSet.mcqs) && currentSet.mcqs.length) {
          totalCount += currentSet.mcqs.length;
          currentSet.mcqs.forEach((q, idx) => {
            const selected = document.querySelector(`input[name=mcq_${idx}]:checked`);
            // mark options
            const options = document.getElementsByName(`mcq_${idx}`);
            options.forEach(opt => {
              const parent = opt.closest('.option-wrapper');
              if (!parent) return;
              // remove previous classes
              parent.classList.remove('bg-success','bg-danger','text-white','p-2');
              if (opt.value === q.correct_answer) {
                parent.classList.add('bg-success','text-white','p-2');
              } else if (opt.checked && opt.value !== q.correct_answer) {
                parent.classList.add('bg-danger','text-white','p-2');
              }
            });
            if (selected && selected.value === q.correct_answer) {
              score++;
              breakdown.push({type:'MCQ', question: q.question, result: 'correct'});
            } else {
              breakdown.push({type:'MCQ', question: q.question, result: 'wrong'});
            }
          });
        }

        // Multi-select
        if (Array.isArray(currentSet.multi_mcqs) && currentSet.multi_mcqs.length) {
          totalCount += currentSet.multi_mcqs.length;
          currentSet.multi_mcqs.forEach((q, idx) => {
            const checkedEls = Array.from(document.querySelectorAll(`input[name=multi_${idx}]:checked`)).map(e => e.value);
            const options = document.getElementsByName(`multi_${idx}`);
            options.forEach(opt => {
              const parent = opt.closest('.option-wrapper');
              if (!parent) return;
              parent.classList.remove('bg-success','bg-danger','text-white','p-2');
              if ((q.answer || []).includes(opt.value)) {
                parent.classList.add('bg-success','text-white','p-2');
              } else if (opt.checked && !(q.answer || []).includes(opt.value)) {
                parent.classList.add('bg-danger','text-white','p-2');
              }
            });
            // check exact match (order-insensitive)
            const given = checkedEls.slice().sort();
            const correct = (q.answer || []).slice().sort();
            const isMatch = given.length === correct.length && given.every((v,i)=>v===correct[i]);
            if (isMatch) { score++; breakdown.push({type:'Multi', question: q.question, result: 'correct'}); }
            else { breakdown.push({type:'Multi', question: q.question, result: 'wrong'}); }
          });
        }

        // Fill-in-the-blanks
        if (Array.isArray(currentSet.fill_blanks) && currentSet.fill_blanks.length) {
          totalCount += currentSet.fill_blanks.length;
          currentSet.fill_blanks.forEach((q, idx) => {
            const input = document.querySelector(`input[name=fill_${idx}]`);
            const user = input ? input.value.trim().toLowerCase() : '';
            const correct = (q.correct_answer || q.answer || '').toString().trim().toLowerCase();
            // show correct answer when wrong
            const correctDiv = input ? input.parentElement.querySelector('.correct-fill') : null;
            if (correctDiv) {
              correctDiv.classList.add('d-none');
              correctDiv.querySelector('span').innerText = correct || '';
            }
            if (user && user === correct && correct !== '') {
              score++;
              breakdown.push({type:'Fill', question: q.question, result:'correct'});
            } else {
              breakdown.push({type:'Fill', question: q.question, result:'wrong'});
              if (correctDiv) {
                correctDiv.classList.remove('d-none');
              }
            }
          });
        }

        // SAQs are not auto-graded - include in breakdown as "manual"
        if (Array.isArray(currentSet.saqs) && currentSet.saqs.length) {
          currentSet.saqs.forEach((q, idx) => {
            breakdown.push({type:'SAQ', question: q.question, result:'manual'});
          });
        }

        // show results
        document.getElementById('results').innerText = `You scored ${score} out of ${totalCount} (auto-graded items)`;
        // results breakdown (first 12 items for brevity)
        const short = breakdown.slice(0, 50).map((b,i) => `${i+1}. [${b.type}] ${b.result.toUpperCase()} â€” ${b.question}`).join('\\n');
        document.getElementById('results-breakdown').innerText = short || '';

        // scroll to top so user sees the result panel
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Allow Enter key on textarea to generate? no - keep manual
    </script>
  </body>
</html>
